## å¦‚ä½•å‘å¸ƒä¸€ä¸ª npm åŒ… 
### å‘å¸ƒå‰

 `npm` åŒ…çš„å‘å¸ƒéœ€è¦æä¾›ä¸¤ä¸ªå…³é”®ä¿¡æ¯ï¼š`registry`å’Œ `access token` ã€‚

 `registry` æŒ‡å®šå‘å¸ƒçš„ä»“åº“çš„åœ°å€ï¼› `access token` è§„å®šè®¿é—®æƒé™ï¼Œæ˜¯ä¸€ä¸²16è¿›åˆ¶çš„å­—ç¬¦ä¸²ã€‚

#### ç™»å½•

CLI é‡Œå¯¹ token çš„æ“ä½œä»¥åŠåŒ…å‘å¸ƒ (automation token é™¤å¤–) éƒ½å¿…é¡»é¢„å…ˆç™»å½•ã€‚

ä½¿ç”¨ `npm login`ï¼Œç„¶åè¾“å…¥å¯†ç é‚®ç®±å³å¯ã€‚å¯ä»¥ç”¨è¿‡ `npm whoami` æ¥éªŒè¯ç™»å½•çŠ¶æ€ã€‚

#### Access Token

 `access token` çš„å¯ä»¥é€šè¿‡ `Web` æ¥ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `CLI` ç”Ÿæˆã€‚æ¯æ¬¡è°ƒç”¨ `npm login` éƒ½ä¼šç”Ÿæˆä¸€æ¡æ–°çš„ tokenã€‚

##### ç±»å‹

Token åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š`read only`ã€`publish`ã€`automation` ï¼›

* `read only` ï¼šåªå…è®¸å®‰è£…å’Œåˆ†å‘ï¼›
* `publish` ï¼šå…è®¸å®‰è£…ã€åˆ†å‘ã€ä¿®æ”¹ã€å‘å¸ƒä»¥åŠå¯¹å¸æˆ·æ‰€æœ‰æƒï¼›
* `automation` ï¼šä¸»è¦ç”¨äº `CI` ç¯å¢ƒçš„åŒ…å‘å¸ƒå¹¶ä¸”`ä¸èƒ½åœ¨ CLI é‡Œåˆ›å»º automation token`ï¼Œå¯ä»¥é¿å…åŒå› å­è®¤è¯ (2FA) çš„å¯†ç è¾“å…¥ï¼›

##### æŸ¥çœ‹

ç”Ÿæˆçš„ token å¯ä»¥é€šè¿‡ `npm token` æˆ– `npm token list` å‘½ä»¤æ¥æŸ¥çœ‹ï¼š

``` shell
âœ  lerna-learning git:(main) âœ— npm token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id     â”‚ token   â”‚ created    â”‚ readonly â”‚ CIDR whitelist â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ f09eeb â”‚ d60c64â€¦ â”‚ 2021-02-19 â”‚ no       â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 788d8e â”‚ 7516cdâ€¦ â”‚ 2021-02-19 â”‚ no       â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 77cda0 â”‚ 39fe9dâ€¦ â”‚ 2021-02-19 â”‚ no       â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ç”Ÿæˆ

é€šè¿‡ `npm token create`ï¼Œç„¶åè¾“å…¥å¯†ç å³å¯åˆ›å»ºä¸€ä¸ª`å¯å‘å¸ƒ`çš„ tokenã€‚

``` shell
 npm token create [--read-only] [--cidr=<cidr-ranges>]
 ```

``` shell
âœ  lerna-learning git:(main) âœ— npm token create
npm password: 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ token          â”‚ d554bd1e-3ec2-49d9-a0c7-36e967efcd87 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cidr_whitelist â”‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ readonly       â”‚ false                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ automation     â”‚ false                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ created        â”‚ 2021-02-19T06:12:45.787Z             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Token æœ‰å‡ ä¸ªå±æ€§ï¼š

* `cidr_whitelist` ï¼šå¯ä»¥æŒ‡å®šIPèŒƒå›´å†…çš„åœ°å€å¯è®¿é—®ï¼›
* `readonly` ï¼šåªè¯»æƒé™ï¼›
* `automation` ï¼šæ˜¯å¦æ˜¯è‡ªåŠ¨åŒ– tokenï¼›
* `create` ï¼štoken åˆ›å»ºæ—¶é—´ï¼›

> token ç”Ÿæˆååªå±•ç¤ºä¸€æ¬¡ï¼Œåé¢å°†æ°¸è¿œä¸å†å±•ç¤ºï¼›é€šè¿‡ CLI æ–¹å¼`ä¸èƒ½`ç”Ÿæˆ `automation token`ï¼Œå³ automation æ°¸è¿œæ˜¯ falseï¼›

##### ç§»é™¤

ä½¿ç”¨ `npm token revoke <token|id>`ï¼Œå³å¯ç§»é™¤ tokenï¼š

``` shell
âœ  lerna-learning git:(main) âœ— npm token revoke f09eeb
Removed 1 token
```

#### Registry

æŒ‡å®šä¸€ä¸ªç›®æ ‡ä»“åº“ï¼Œç”¨äºå­˜å‚¨å‘å¸ƒåŒ…ï¼Œé»˜è®¤ `npm registry` çš„å€¼ä¸ºï¼š<https://registry.npmjs.org>ã€‚

npm çš„ `registry` ä½¿ç”¨çš„æ˜¯[couch database](https://couchdb.apache.org/)æ•°æ®åº“ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ RESTful API æ–¹å¼è®¿é—®æ•°æ®ã€‚

##### ä¿®æ”¹ registry

åœ¨ `package.json` æ·»åŠ  `publishConfig.registry`ï¼ŒæŠŠå‘å¸ƒåŒ…æŒ‡å‘ä¸€ä¸ªå†…éƒ¨ä»“åº“ï¼š

``` json
{
  "publishConfig":{"registry":"http://my-internal-registry.local"}
}
```

å¦‚æœæ²¡æœ‰æŒ‡å®š publishConfigï¼Œé»˜è®¤ä½¿ç”¨ npm registry å±æ€§å€¼æ¥å‘å¸ƒã€‚

### å‘å¸ƒ (Publish)

ç›´æ¥æ‰§è¡Œ `npm publish` å³å¯ï¼š

``` shell
npm publish [<tarball>|<folder>] [--tag <tag>] [--access <public|restricted>] [--otp otpcode] [--dry-run]
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

* å¦‚æœå‘å¸ƒçš„åŒ…æ˜¯ä¸€ä¸ª scope åŒ…ï¼Œé‚£ä¹ˆå¿…é¡»æŒ‡å®š `--access=public`ã€‚
* å¦‚æœè¿œç¨‹ä»“åº“å¼€å¯äº†åŒå› å­è®¤è¯ (2FA) ï¼Œé‚£ä¹ˆå¿…é¡»æŒ‡å®š `--otp optcode`ã€‚

``` shell
âœ  lerna-learning git:(main) âœ— npm publish --access=public
npm notice 
npm notice ğŸ“¦  @dun-cat/lerna-learning@1.0.1
npm notice === Tarball Contents === 
npm notice 616B package.json               
npm notice 28B  index.js                   
npm notice === Tarball Details === 
npm notice name:          @dun-cat/lerna-learning                 
npm notice version:       1.0.1                                   
npm notice package size:  990 B                                   
npm notice unpacked size: 2.4 kB                                  
npm notice shasum:        3097ce97e0aa99f9d1001bc8697b529775a304cc
npm notice integrity:     sha512-zVB5Cl0/HP3zM[...]LP7bQKnBGZAOQ==
npm notice total files:   9                                       
npm notice 
+ @dun-cat/lerna-learning@1.0.1
```

Tipï¼šæ¯æ¬¡å‘å¸ƒ `package.json` é‡Œçš„ `version` ç‰ˆæœ¬å·å¿…é¡»è¿›è¡Œ`ç´¯åŠ `ï¼Œå¦åˆ™å‘å¸ƒå¤±è´¥ã€‚

#### ç´¯åŠ ç‰ˆæœ¬å·

é€šè¿‡ `npm version` å‘½ä»¤å¯ä»¥å®ç°ä¿®æ”¹ç‰ˆæœ¬å·ï¼Œ

``` shell
 npm version [<newversion> | major | minor | patch | premajor | preminor | prepatch | prerelease [--preid=<prerelease-id>] | from-git]
```

æ¯æ¬¡ `npm verion` æ‰§è¡Œï¼Œä¼šæäº¤ä¸€æ¡æ–°çš„ `git commit` è®°å½•ï¼Œå¹¶æ‰“ä¸Šç‰ˆæœ¬å· `tag`ï¼Œå¯ä»¥é€šè¿‡ `--no-git-tag-version` æ¥å–æ¶ˆæ­¤æ“ä½œï¼š

``` shell
npm --no-git-tag-version version patch
```

### CI/CD ç¯å¢ƒä¸‹çš„è‡ªåŠ¨å‘å¸ƒ

#### ä½¿ç”¨ automation token

åœ¨ CI/CD ç¯å¢ƒç›´æ¥ä½¿ç”¨ `automation token` æ¥é¿å…åŒå› å­è®¤è¯çš„å¯†ç è¾“å…¥ã€‚

å¯ä»¥å°† token é…ç½®åˆ° `.npmrc` æ–‡ä»¶é‡Œã€‚å¦‚æœé¡¹ç›®æ ¹ç›®å½•åŒ…å« .npmrc åˆ™ä¼˜å…ˆä½¿ç”¨å®ƒã€‚å¯¹äºå·²å®‰è£… npm çš„ç”¨æˆ·ï¼Œç”¨æˆ·ç›®å½•ä¼šåŒ…å«ä¸€ä»½ä½œç”¨å…¨å±€çš„ `~/.npmrc` æ–‡ä»¶ï¼Œé€šå¸¸ä½¿ç”¨å®ƒä½œä¸º CD ä¼šæ›´ä¸ºæ–¹ä¾¿ã€‚

``` xml
//registry.npmjs.org/:_authToken=${NPM_TOKEN}
```

> è¯·ä½¿ç”¨`ç¯å¢ƒå˜é‡`èµ‹å€¼`_authToken`ï¼Œåˆ‡è®°ä¸è¦ç›´æ¥æŠŠ token ç›´æ¥å†™åˆ° .npmrc æ–‡ä»¶é‡Œå»ã€‚

#### é…ç½® package.json

æˆ‘ä»¬æŠŠ`ç‰ˆæœ¬å·ç´¯åŠ `åŠ`åŒ…å‘å¸ƒ`é…ç½®åˆ° `package.json` çš„ `scripts` æ¥æ‰§è¡Œï¼š

``` json
{
  "scripts": {
    "pub": "npm run updateVersion && npm publish --access=public",
    "updateVersion": "npm --no-git-tag-version version patch"
  },
}
```
